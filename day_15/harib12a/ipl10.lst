     1                                  ; haribote-ipl
     2                                  ; TAB=4
     3                                  ; os自作入門のusbブート - Qiita https://qiita.com/phoneticdata/items/9b0c74f59aba9c0a2ed1
     4                                  ; qemu-system-x86_64 -usb にて起動する
     5                                  
     6                                  
     7                                  [bits 16]
     8                                  [ORG 0x7c00]
     9                                          ;; BPB Structure                                                                                                                     
    10 00000000 EB58                    JMP     entry           ;BS_jmpBoot
    11 00000002 90                      NOP                                                                                                  
    12 00000003 48415249424F5445        BS_OEMName      DB "HARIBOTE"
    13 0000000B 0002                    BPB_BytsPerSec  DW 0x0200
    14 0000000D 01                      BPB_SecPerClus  DB 0x01
    15 0000000E 0100                    BPB_RsvdSecCnt  DW 0x0001
    16 00000010 02                      BPB_NumFATs     DB 0x02
    17 00000011 0000                    BPB_RootEntCnt  DW 0x0000
    18 00000013 0000                    BPB_TotSec16    DW 0x0000
    19 00000015 F8                      BPB_Media       DB 0xf8
    20 00000016 0000                    BPB_FATSz16     DW 0x0000
    21 00000018 FFFF                    BPB_SecPerTrk   DW 0xffff
    22 0000001A 0100                    BPB_NumHeads    DW 0x0001
    23 0000001C 00000000                BPB_HiDDSec     DD 0x00000000
    24 00000020 0050EE00                BPB_TotSec32    DD 0x00ee5000
    25 00000024 ED000000                BPB_FATSz32     DD 0x000000ed
    26 00000028 0000                    BPB_ExtFlags    DW 0x0000
    27 0000002A 0000                    BPB_FSVer       DW 0x0000
    28 0000002C 00000000                BPB_RootClus    DD 0x00000000
    29 00000030 0100                    BPB_FSInfo      DW 0x0001
    30 00000032 0000                    BPB_BkBootSec   DW 0x0000
    31 00000034 00<rept>                times   12      DB 0    ;BPB_Reserverd                                                                                               
    32 00000040 80                      BS_DrvNum       DB 0x80
    33 00000041 00                      BS_Reserved1    DB 0x00
    34 00000042 29                      BS_BootSig      DB 0x29
    35 00000043 5C610A0A                BS_VolID        DD 0xa0a615c
    36 00000047 49534849484120424F-     BS_VolLab       DB "ISHIHA BOOT"
    37 00000050 4F54               
    38 00000052 4641543332202020        BS_FileSysType  DB "FAT32   "
    39                                  
    40                                  
    41                                  
    42                                  entry:  
    43 0000005A FA                          CLI
    44                                  
    45 0000005B B80000                      MOV AX, 0
    46 0000005E 8ED8                        MOV DS, AX
    47 00000060 8ED0                        MOV SS, AX
    48 00000062 8EC0                        MOV ES, AX
    49 00000064 89C3                        MOV BX, AX
    50 00000066 89C1                        MOV CX, AX
    51 00000068 BC007C                      MOV SP, 0x7c00
    52                                  prepare:
    53 0000006B FB                          STI
    54 0000006C 8816[6A01]                  MOV [drv], DL
    55                                  
    56 00000070 B441                        MOV AH, 0x41                ; Set Function 0x41
    57 00000072 BBAA55                      MOV word bx, 0x55aa          
    58 00000075 CD13                        INT 0x13                   ; Call Interupt
    59 00000077 0F82EA00                    JC unsupported        ; If Extentions aren't Supported, Jump
    60                                  
    61                                  
    62                                  
    63                                  
    64 0000007B 31C0                       xor ax, ax
    65 0000007D 83C001                     add ax, 1                   ; clear carry flag
    66 00000080 6631FF                     XOR EDI, EDI
    67                                  
    68 00000083 B445                       MOV AH, 0x45
    69 00000085 B001                       MOV AL, 0x01
    70 00000087 B280                       MOV DL, 0x80
    71 00000089 CD13                       INT 0x13
    72                                  
    73 0000008B B80000                     MOV AX, 0
    74 0000008E 8ED8                       MOV DS, AX
    75                                  
    76                                  loop:
    77 00000090 B100                        MOV CL, 0
    78                                  retry:
    79 00000092 1E                          PUSH DS
    80 00000093 6660                        PUSHAD
    81 00000095 8A16[6A01]                  MOV DL, [drv]
    82 00000099 B442                        MOV AH, 0x42
    83 0000009B B000                        MOV AL, 0x00
    84 0000009D BE[6B01]                    MOV SI, DAPS
    85 000000A0 CD13                        INT 0x13
    86 000000A2 7310                        JNC next
    87                                  
    88 000000A4 80C101                      ADD CL, 1
    89 000000A7 B280                        MOV DL, 0x80 
    90 000000A9 B400                        MOV AH, 0x00
    91 000000AB CD13                        INT 0x13
    92 000000AD 80F906                      CMP CL, 6
    93 000000B0 7379                        JAE error
    94 000000B2 EBDE                        JMP retry
    95                                  next:
    96                                  
    97 000000B4 6631C0                      XOR EAX, EAX
    98 000000B7 6631DB                      XOR EBX, EBX
    99 000000BA 6631C9                      XOR ECX, ECX
   100                                  
   101 000000BD 6683C701                    ADD EDI, 1
   102 000000C1 66B9[73010000]              MOV ECX, lba0
   103 000000C7 66678939                    MOV [ECX], EDI
   104                                  
   105 000000CB 6631C0                      XOR EAX, EAX
   106 000000CE 6631C9                      XOR ECX, ECX
   107 000000D1 6631ED                      XOR EBP, EBP
   108                                  
   109 000000D4 A1[6F01]                    MOV AX, [addr]
   110 000000D7 66B9[6F010000]              MOV ECX, addr
   111 000000DD 66BB[71010000]              MOV EBX, segm
   112 000000E3 050002                      ADD AX, 0x200
   113 000000E6 83D500                      ADC BP, 0
   114 000000E9 C1E50C                      SHL BP, 12
   115 000000EC 032E[7101]                  ADD BP, [segm]
   116 000000F0 67892B                      MOV [EBX], BP
   117                                  
   118                                  
   119 000000F3 678901                      MOV [ECX], AX
   120 000000F6 67892B                      MOV [EBX], BP
   121                                  
   122 000000F9 6681FF6A010000              CMP EDI, 0x16a
   123 00000100 728E                        JB loop
   124                                  
   125 00000102 66B900C20000                MOV ECX, 0xc200
   126                                  
   127 00000108 66B800000000                MOV EAX, 0x0000
   128 0000010E 6689C3                      MOV EBX, EAX
   129 00000111 6689C2                      MOV EDX, EAX
   130 00000114 6689C5                      MOV EBP, EAX
   131 00000117 6689C6                      MOV ESI, EAX
   132 0000011A 6689C7                      MOV EDI, EAX
   133                                  
   134 0000011D B50A                        MOV CH, 10
   135 0000011F 882EF00F                    MOV [0x0ff0], CH
   136                                  
   137 00000123 6689C1                      MOV ECX, EAX
   138 00000126 EA00C20000                  JMP 0x0000:0xc200
   139                                  error:
   140 0000012B 6661                        POPAD
   141 0000012D 1F                          POP DS
   142 0000012E BE[4601]                    MOV     SI,msg
   143                                  putloop:
   144 00000131 8A04                        MOV     AL,[SI]
   145 00000133 83C601                      ADD     SI,1            
   146 00000136 3C00                        CMP     AL,0
   147 00000138 7409                        JE      fin
   148 0000013A B40E                        MOV     AH,0x0e         
   149 0000013C BB0000                      MOV     BX,0       
   150 0000013F CD10                        INT     0x10           
   151 00000141 EBEE                        JMP     putloop
   152                                  fin:
   153 00000143 F4                          HLT                     
   154 00000144 EBFD                        JMP     fin            
   155                                  msg:
   156 00000146 0A0A                        DB      0x0a, 0x0a      
   157 00000148 6C6F6164206572726F-         DB      "load error"
   158 00000151 72                 
   159 00000152 0A                          DB      0x0a            
   160 00000153 00                          DB      0
   161                                  msg1:
   162 00000154 0A0A                        DB      0x0a, 0x0a      
   163 00000156 6E6F7420737570706F-         DB      "not supported"
   164 0000015F 72746564           
   165 00000163 0A                          DB      0x0a            
   166 00000164 00                          DB      0
   167                                  
   168                                  unsupported:
   169 00000165 BE[5401]                    MOV SI, msg1
   170 00000168 EBC7                        JMP putloop
   171                                  
   172 0000016A 80                      drv:    DB 0x80
   173 0000016B 10                      DAPS:   DB 0x10               ; Size of Structure (16 bytes, always this for DAPS)
   174 0000016C 00                              DB 0                  ; Always 0
   175 0000016D 01                              DB 1                  ; Number of Sectors to Read (1x512)
   176 0000016E 00                              DB 0                  ; Always 0 
   177 0000016F 0080                    addr:   DW 0x8000             ; Target Location for Reading To (0x8000 = 0x0800:0x0000)  
   178 00000171 0000                    segm:   DW 0x0000             ; Page Table (0, Disabled)
   179 00000173 01000000                lba0:   DD 1                  ; Read from 2nd block (code I want to load)
   180 00000177 00000000                        DD 0                  ; Large LBAs, dunno what this does
   181                                  
   182                                  
   183                                  
   184 0000017B <res 00000083>              RESB    0x01fe-($-$$)       
   185          ******************       warning: uninitialized space declared in .text section: zeroing
   186 000001FE 55AA                        DW 0AA55h
